<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin • Baskets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      html, body { height: 100%; }
      body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
      .card { @apply bg-white rounded-xl shadow-sm ring-1 ring-black/5; }
      .soft { box-shadow: 0 10px 20px -10px rgba(0,0,0,.10), 0 6px 12px -6px rgba(0,0,0,.08); }
      .hover-soft:hover { box-shadow: 0 14px 28px -12px rgba(0,0,0,.12), 0 10px 20px -10px rgba(0,0,0,.10); }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#eef6ff', 100: '#d9ecff', 200: '#bcdcfe', 300: '#94c6fd', 400: '#5aa6fb',
                500: '#3088f7', 600: '#1f6de9', 700: '#1c59c9', 800: '#1b4aa1', 900: '#1b417f'
              }
            }
          }
        }
      }
    </script>
  </head>
  <body class="bg-slate-50 min-h-full">
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useState, useEffect } = React;

      // ---- Mock data ----
      const MOCK_BASKETS = Array.from({ length: 42 }).map((_, i) => {
        const itemCount = Math.floor(Math.random() * 6) + 1;
        const products = Array.from({ length: itemCount }).map((__, j) => {
          const price = (Math.floor(Math.random() * 9) + 1) * 250_000;
          const qty = Math.floor(Math.random() * 3) + 1;
          return {
            id: i * 1000 + j,
            name: `Product ${i+1}-${j+1}`,
            image: `https://picsum.photos/seed/${i}-${j}/96/96`;
            quantity: qty,
            price_toman: price,
            subtotal: price * qty,
          };
        });
        const subtotal = products.reduce((s,p) => s + p.subtotal, 0);
        const statuses = ['active', 'abandoned', 'converted'];
        const status = statuses[Math.floor(Math.random() * statuses.length)];
        const lastDays = Math.floor(Math.random() * 30);
        const updatedAt = new Date(Date.now() - lastDays * 24 * 3600 * 1000);
        return {
          id: `BKT-${(100000 + i).toString(36).toUpperCase()}`,
          customer: {
            name: `Customer ${i+1}`,
            email: `user${i+1}@example.com`
          },
          updatedAt: updatedAt.toISOString(),
          items: products,
          status,
          totals: {
            merchandise_subtotal: subtotal,
            discount_total: 0,
            shipping_total: 0,
            tax_total: 0,
            grand_total: subtotal,
            item_count: products.reduce((s,p) => s + p.quantity, 0)
          }
        };
      });

      const currency = (n) => new Intl.NumberFormat('fa-IR', { maximumFractionDigits: 0 }).format(n) + ' تومان';
      const fmtDate = (s) => new Date(s).toLocaleDateString('fa-IR', { year:'numeric', month:'short', day:'numeric' });

      // ---- UI Elements ----
      const Badge = ({ color = 'slate', children }) => (
        <span className={`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium bg-${color}-100 text-${color}-800`}>{children}</span>
      );

      const Tag = ({ children }) => (
        <span className="inline-flex items-center gap-1 rounded-md bg-slate-100 px-2 py-1 text-xs text-slate-700">{children}</span>
      );

      const Card = ({ className = '', children }) => (
        <div className={`card soft hover-soft transition-shadow ${className}`}>{children}</div>
      );

      const Button = ({ children, variant = 'primary', className = '', ...props }) => {
        const base = 'inline-flex items-center gap-2 rounded-lg px-3.5 py-2.5 text-sm font-medium transition shadow-sm';
        const variants = {
          primary: 'bg-brand-600 text-white hover:bg-brand-700',
          ghost: 'bg-white text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50',
          danger: 'bg-rose-600 text-white hover:bg-rose-700',
          success: 'bg-emerald-600 text-white hover:bg-emerald-700',
        };
        return <button className={`${base} ${variants[variant]} ${className}`} {...props}>{children}</button>;
      };

      // ---- Filters & Sorting ----
      const FiltersBar = ({ filters, setFilters, total }) => {
        return (
          <Card className="p-4">
            <div className="flex flex-col md:flex-row md:items-end gap-3">
              <div className="flex-1">
                <label className="text-xs text-slate-500">Search</label>
                <input
                  type="text"
                  placeholder="Customer, email, or basket ID"
                  value={filters.query}
                  onChange={e => setFilters(f => ({ ...f, query: e.target.value }))}
                  className="mt-1 block w-full rounded-lg border-slate-200 focus:border-brand-400 focus:ring-brand-400"
                />
              </div>
              <div>
                <label className="text-xs text-slate-500">Status</label>
                <select className="mt-1 block w-full rounded-lg border-slate-200" value={filters.status} onChange={e => setFilters(f => ({ ...f, status: e.target.value }))}>
                  <option value="all">All</option>
                  <option value="active">Active</option>
                  <option value="abandoned">Abandoned</option>
                  <option value="converted">Converted</option>
                </select>
              </div>
              <div>
                <label className="text-xs text-slate-500">Sort by</label>
                <select className="mt-1 block w-full rounded-lg border-slate-200" value={filters.sort} onChange={e => setFilters(f => ({ ...f, sort: e.target.value }))}>
                  <option value="-updatedAt">Last updated</option>
                  <option value="-total">Total price (desc)</option>
                  <option value="total">Total price (asc)</option>
                  <option value="-items">Items (desc)</option>
                  <option value="items">Items (asc)</option>
                </select>
              </div>
              <div className="flex gap-2 md:ml-auto">
                <Button variant="ghost" onClick={() => exportCSV()}>Export CSV</Button>
                <Button onClick={() => exportCSV(true)}>Export Excel</Button>
              </div>
            </div>
            <div className="mt-3 text-xs text-slate-500">Showing {total} baskets</div>
          </Card>
        );
      };

      // Simple CSV/Excel export (Excel as CSV but with .xls extension for demo)
      function exportCSV(asExcel = false) {
        const fields = ['id','customer.name','customer.email','status','updatedAt','totals.item_count','totals.grand_total'];
        const header = 'id,customer_name,customer_email,status,updated_at,item_count,grand_total';
        const rows = [header, ...MOCK_BASKETS.map(b => [
          b.id,
          b.customer.name,
          b.customer.email,
          b.status,
          b.updatedAt,
          b.totals.item_count,
          b.totals.grand_total,
        ].join(','))].join('\n');
        const blob = new Blob([rows], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = asExcel ? 'baskets.xls' : 'baskets.csv';
        a.click();
        URL.revokeObjectURL(url);
      }

      // ---- Stats ----
      const BasketStats = ({ baskets }) => {
        const total = baskets.length;
        const active = baskets.filter(b => b.status === 'active').length;
        const abandoned = baskets.filter(b => b.status === 'abandoned').length;
        const converted = baskets.filter(b => b.status === 'converted').length;
        const avg = baskets.reduce((s,b) => s + b.totals.grand_total, 0) / Math.max(1, total);
        return (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <Card className="p-4">
              <div className="text-slate-500 text-sm">Total Baskets</div>
              <div className="text-2xl font-semibold mt-1">{total}</div>
            </Card>
            <Card className="p-4">
              <div className="text-slate-500 text-sm">Active</div>
              <div className="text-2xl font-semibold mt-1">{active}</div>
            </Card>
            <Card className="p-4">
              <div className="text-slate-500 text-sm">Abandoned</div>
              <div className="text-2xl font-semibold mt-1">{abandoned}</div>
            </Card>
            <Card className="p-4">
              <div className="text-slate-500 text-sm">Average Value</div>
              <div className="text-2xl font-semibold mt-1">{currency(avg)}</div>
            </Card>
          </div>
        );
      };

      // ---- Table ----
      const BasketRow = ({ basket, onOpen }) => (
        <tr className="hover:bg-slate-50">
          <td className="py-3 px-4 whitespace-nowrap">
            <div className="font-medium text-slate-800">{basket.customer.name}</div>
            <div className="text-xs text-slate-500">{basket.customer.email}</div>
          </td>
          <td className="py-3 px-4 whitespace-nowrap text-slate-600">{basket.id}</td>
          <td className="py-3 px-4 whitespace-nowrap text-slate-600">{fmtDate(basket.updatedAt)}</td>
          <td className="py-3 px-4 whitespace-nowrap">{basket.totals.item_count}</td>
          <td className="py-3 px-4 whitespace-nowrap font-semibold">{currency(basket.totals.grand_total)}</td>
          <td className="py-3 px-4 whitespace-nowrap">
            {basket.status === 'active' && <Badge color="emerald">Active</Badge>}
            {basket.status === 'abandoned' && <Badge color="orange">Abandoned</Badge>}
            {basket.status === 'converted' && <Badge color="blue">Converted</Badge>}
          </td>
          <td className="py-3 px-4 whitespace-nowrap text-right">
            <Button variant="ghost" onClick={() => onOpen(basket)}>View</Button>
          </td>
        </tr>
      );

      const BasketList = ({ baskets, onOpen }) => (
        <Card className="overflow-hidden">
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-slate-200">
              <thead className="bg-slate-50">
                <tr>
                  <th className="py-3 px-4 text-left text-xs font-semibold text-slate-500">Customer</th>
                  <th className="py-3 px-4 text-left text-xs font-semibold text-slate-500">Basket ID</th>
                  <th className="py-3 px-4 text-left text-xs font-semibold text-slate-500">Last Updated</th>
                  <th className="py-3 px-4 text-left text-xs font-semibold text-slate-500">Items</th>
                  <th className="py-3 px-4 text-left text-xs font-semibold text-slate-500">Total</th>
                  <th className="py-3 px-4 text-left text-xs font-semibold text-slate-500">Status</th>
                  <th className="py-3 px-4" />
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {baskets.map(b => <BasketRow key={b.id} basket={b} onOpen={onOpen} />)}
              </tbody>
            </table>
          </div>
        </Card>
      );

      // ---- Drawer / Details ----
      const Drawer = ({ open, onClose, children }) => {
        return (
          <div className={`fixed inset-0 z-50 ${open ? '' : 'pointer-events-none'}`}>
            <div className={`absolute inset-0 bg-black/30 transition-opacity ${open ? 'opacity-100' : 'opacity-0'}`} onClick={onClose} />
            <div className={`absolute right-0 top-0 h-full w-full sm:w-[560px] bg-white shadow-2xl transition-transform ${open ? 'translate-x-0' : 'translate-x-full'}`}>
              {children}
            </div>
          </div>
        );
      };

      const ProductRow = ({ item, onQtyChange, onRemove }) => (
        <div className="flex items-center gap-3 py-3">
          <img src={item.image} alt="" className="h-14 w-14 rounded-md object-cover ring-1 ring-slate-200" />
          <div className="flex-1">
            <div className="font-medium text-slate-800">{item.name}</div>
            <div className="text-sm text-slate-500">{currency(item.price_toman)}</div>
          </div>
          <div className="flex items-center gap-2">
            <button className="h-8 w-8 rounded-md ring-1 ring-slate-200 hover:bg-slate-50" onClick={() => onQtyChange(Math.max(1, item.quantity - 1))}>-</button>
            <input className="w-14 text-center rounded-md ring-1 ring-slate-200" type="number" min="1" value={item.quantity} onChange={e => onQtyChange(Math.max(1, parseInt(e.target.value||'1',10)))} />
            <button className="h-8 w-8 rounded-md ring-1 ring-slate-200 hover:bg-slate-50" onClick={() => onQtyChange(item.quantity + 1)}>+</button>
          </div>
          <div className="w-28 text-right font-semibold">{currency(item.price_toman * item.quantity)}</div>
          <button className="ml-2 text-rose-600 hover:text-rose-700" onClick={onRemove}>Remove</button>
        </div>
      );

      const BasketDetails = ({ basket, onChange, onClose }) => {
        if (!basket) return null;
        const totals = basket.items.reduce((acc, it) => {
          acc.sub += it.price_toman * it.quantity; return acc;
        }, { sub: 0 });
        const summary = {
          merchandise_subtotal: totals.sub,
          discount_total: 0,
          shipping_total: 0,
          tax_total: 0,
          grand_total: totals.sub,
          item_count: basket.items.reduce((s, it) => s + it.quantity, 0),
        };

        const updateItem = (idx, qty) => {
          const items = basket.items.slice();
          items[idx] = { ...items[idx], quantity: qty };
          onChange({ ...basket, items });
        };
        const removeItem = (idx) => {
          const items = basket.items.slice();
          items.splice(idx, 1);
          onChange({ ...basket, items });
        };
        const clearBasket = () => onChange({ ...basket, items: [] });

        const sendReminder = () => alert('Reminder email sent (demo)');
        const convertToOrder = () => alert('Basket converted to order (demo)');
        const applyDiscount = () => {
          const code = prompt('Enter admin discount code (demo):');
          if (code) alert('Discount applied (demo): ' + code);
        };

        return (
          <Drawer open={!!basket} onClose={onClose}>
            <div className="h-full flex flex-col">
              <div className="p-5 border-b border-slate-200 flex items-center justify-between">
                <div>
                  <div className="text-xs text-slate-500">Basket</div>
                  <div className="text-lg font-semibold">{basket.id}</div>
                </div>
                <Button variant="ghost" onClick={onClose}>Close</Button>
              </div>
              <div className="flex-1 overflow-auto p-5 space-y-5">
                <Card className="p-4">
                  <div className="text-sm text-slate-500">Customer</div>
                  <div className="mt-1 font-medium">{basket.customer.name}</div>
                  <div className="text-sm text-slate-600">{basket.customer.email}</div>
                  <div className="mt-2">
                    {basket.status === 'active' && <Badge color="emerald">Active</Badge>}
                    {basket.status === 'abandoned' && <Badge color="orange">Abandoned</Badge>}
                    {basket.status === 'converted' && <Badge color="blue">Converted</Badge>}
                  </div>
                </Card>

                <Card className="p-4">
                  <div className="text-sm font-medium">Items</div>
                  <div className="divide-y divide-slate-100">
                    {basket.items.length === 0 && <div className="py-6 text-slate-500 text-sm">No items</div>}
                    {basket.items.map((it, idx) => (
                      <ProductRow key={it.id} item={it} onQtyChange={(q) => updateItem(idx, q)} onRemove={() => removeItem(idx)} />
                    ))}
                  </div>
                  <div className="mt-4 flex justify-between text-sm text-slate-600">
                    <div>Items: <span className="font-medium text-slate-800">{summary.item_count}</span></div>
                    <div>Subtotal: <span className="font-semibold">{currency(summary.merchandise_subtotal)}</span></div>
                  </div>
                </Card>

                <div className="flex flex-wrap gap-2">
                  <Button variant="ghost" onClick={clearBasket}>Clear Basket</Button>
                  <Button variant="ghost" onClick={applyDiscount}>Apply Discount</Button>
                  <Button onClick={sendReminder}>Send Reminder</Button>
                  <Button variant="success" onClick={convertToOrder}>Convert to Order</Button>
                </div>
              </div>
              <div className="p-5 border-t border-slate-200 flex items-center justify-between">
                <div className="text-sm text-slate-600">Last updated: {fmtDate(basket.updatedAt)}</div>
                <div className="text-lg font-semibold">{currency(summary.grand_total)}</div>
              </div>
            </div>
          </Drawer>
        );
      };

      // ---- Pagination ----
      const Pagination = ({ page, pages, onPage }) => {
        const prev = () => onPage(Math.max(1, page - 1));
        const next = () => onPage(Math.min(pages, page + 1));
        return (
          <div className="flex items-center justify-between mt-4">
            <div className="text-sm text-slate-500">Page {page} of {pages}</div>
            <div className="flex gap-2">
              <Button variant="ghost" onClick={prev} disabled={page === 1}>Previous</Button>
              <Button variant="ghost" onClick={next} disabled={page === pages}>Next</Button>
            </div>
          </div>
        );
      };

      // ---- Root Page ----
      const App = () => {
        const [filters, setFilters] = useState({ query: '', status: 'all', sort: '-updatedAt' });
        const [page, setPage] = useState(1);
        const pageSize = 10;
        const [selected, setSelected] = useState(null);
        const [data, setData] = useState(MOCK_BASKETS);

        const filtered = useMemo(() => {
          const q = filters.query.trim().toLowerCase();
          let rows = data.filter(b => {
            const matchQ = !q || b.id.toLowerCase().includes(q) || b.customer.name.toLowerCase().includes(q) || b.customer.email.toLowerCase().includes(q);
            const matchStatus = filters.status === 'all' || b.status === filters.status;
            return matchQ && matchStatus;
          });
          switch (filters.sort) {
            case 'total': rows.sort((a,b) => a.totals.grand_total - b.totals.grand_total); break;
            case '-total': rows.sort((a,b) => b.totals.grand_total - a.totals.grand_total); break;
            case 'items': rows.sort((a,b) => a.totals.item_count - b.totals.item_count); break;
            case '-items': rows.sort((a,b) => b.totals.item_count - a.totals.item_count); break;
            case 'updatedAt': rows.sort((a,b) => new Date(a.updatedAt) - new Date(b.updatedAt)); break;
            case '-updatedAt':
            default: rows.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
          }
          return rows;
        }, [filters, data]);

        const pages = Math.max(1, Math.ceil(filtered.length / pageSize));
        useEffect(() => { setPage(1); }, [filters.query, filters.status, filters.sort]);
        const paged = useMemo(() => filtered.slice((page-1)*pageSize, page*pageSize), [filtered, page]);

        return (
          <div className="max-w-7xl mx-auto p-6 space-y-6">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-xs text-slate-500">Dashboard</div>
                <h1 className="text-2xl font-semibold">Customer Baskets</h1>
              </div>
              <div className="flex items-center gap-2">
                <Tag>Responsive</Tag>
                <Tag>Mock Data</Tag>
              </div>
            </div>

            <BasketStats baskets={filtered} />
            <FiltersBar filters={filters} setFilters={setFilters} total={filtered.length} />
            <BasketList baskets={paged} onOpen={setSelected} />
            <Pagination page={page} pages={pages} onPage={setPage} />

            <BasketDetails basket={selected} onChange={setSelected} onClose={() => setSelected(null)} />
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
  </html>


